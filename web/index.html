<html>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
 <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.23/jquery-ui.min.js"></script>

<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.4/leaflet.css" />
<script src="http://cdn.leafletjs.com/leaflet-0.4/leaflet.js"></script>
<link rel="stylesheet" href="style.css" />
<style>
.string { color: green; }
.number { color: darkorange; }
.boolean { color: blue; }
.null { color: magenta; }
.key { color: red; }

#debug {
    font-size: 11px;
}

.ui-autocomplete .ui-menu-item {
    font-size:13px;
}

.ui-autocomplete .ui-menu-item .city {
    font-size: 11px;
    color:#482;
}
.ui-autocomplete .ui-menu-item .type {
    font-size: 11px;
    color:#822;
}
.ui-autocomplete .ui-menu-item .debugÂ {
    font-size: 11px;
    color:#bbb;
}

.ui-menu {
 z-index: 1001;
}


#map { width: 100%; height: 600px; }
</style>
</head>

<body>
<table style="width:100%; height:100%; vertical-align:top">
<tr>
<td colspan="2" style="width:100%; vertical-align:top;">
<div class="ui-widget" style="margin:0 auto; width:100%; text-align: center">
<!--    <label for="name">Look up an OSM name</label>-->
        <input id="name" style="width:600px" />
        <label for="display_debug">debug</label>
        <input id="display_debug" type="checkbox" />
</div>
<div id="results">
</div>
</td>
</tr>
<tr>
<td style="vertical-align:top; width: 30%">

<h4>Nominatim results</h4>

<div id="nominatim">

</div>

<h4>Debug info</h4>
<div id="debug">
</div>

</td>
<td style="width:70%; vertical-align: top;">
<div id="map">
</div>
</td>

</tr>
</table>

<script>
/* Stolen from stackoverflow.com/questions/4810841 */
function syntaxHighlight(json) {
    if (typeof json != 'string') {
         json = JSON.stringify(json, undefined, '\t');
    }
    json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
        var cls = 'number';
        if (/^"/.test(match)) {
            if (/:$/.test(match)) {
                cls = 'key';
            } else {
                cls = 'string';
            }
        } else if (/true|false/.test(match)) {
            cls = 'boolean';
        } else if (/null/.test(match)) {
            cls = 'null';
        }
        return '<span class="' + cls + '">' + match + '</span>';
    });
}


$(document).ready(function() {
    var map = L.map("map",  {
            center : new L.LatLng(25, 0),
            zoom: 3
        });
    var mapnikLayer = new L.TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                   maxZoom: 18,
                   attribution: 'OpenStreetMap'                                                                                                     
    });

    var markers = new L.LayerGroup();

    map.addLayer(mapnikLayer);
    markers.addTo(map); 

$( "#name" ).autocomplete({
    appendTo : '#results',
    delay : 50,
    source: function(request, response) {
        $.getJSON("complete?q=" + request.term, function(data) {
            //markers.clearLayers();
            //
            out = Array();
            for (var match in data.matches) {
                complexMatch = data.matches[match];
                out.push(complexMatch);
            }
            //console.info(out);
            response(out);
            //data.matches);
            if ($("#display_debug").attr('checked')) {
                $("#debug").html("<pre>" + syntaxHighlight(data.debug)+ "</pre>");
            }
        });
    },
    minLength: 2,

/*   focus: function( event, ui ) {
                $( "#name" ).val( ui.item.name );
                return false;
            }*/

         open: function(){
        $(this).autocomplete('widget').css('z-index', 1001);
        return false;
    },


     select: function( event, ui ) {
        $( "#name" ).val( ui.item.name );
        var latlng = new L.LatLng(ui.item.lat, ui.item.lon);
        markers.addLayer(new L.Marker(latlng));
        var sw = new L.LatLng(latlng.lat - 0.006, latlng.lng - 0.006);    
        var ne = new L.LatLng(latlng.lat + 0.006, latlng.lng + 0.006);    
     
        map.fitBounds(new L.LatLngBounds(sw, ne));
        
        $("#nominatim").html("Searching ...");
    
        $.getJSON("nominatim?q=" + ui.item.name + "&format=json&contact=clement.stenac@gmail.com", function(data) {
            var html = "<ul>";
            for (var i in data) {
                html += "<li>" + data[i]["display_name"] + "</li>";
            }
            html += "</ul>";
            $("#nominatim").html(html);
        });
                return false;
            }

/*
 * [{"place_id":"149504608","licence":"Data \u00a9 OpenStreetMap contributors, ODbL 1.0. http:\/\/www.openstreetmap.org\/copyright","osm_type":"relation","osm_id":"1975394","boundingbox":["47.9329299926758","47.945858001709","13.9792394638062","13.9879875183105"],"lat":"47.939393","lon":"13.9844633367229","display_name":"Test, Gemeinde Scharnstein, Bezirk Gmunden, Upper Austria, 4644, Austria","class":"landuse","type":"farmland"},{"place_id":"27977114","licence":"Data \u00a9 OpenStreetMap contributors, ODbL 1.0. http:\/\/www.openstreetmap.org\/copyright","osm_type":"way","osm_id":"14494972","boundingbox":["32.6140632629395","32.6165046691895","-108.98770904541","-108.982727050781"],"lat":"32.61448","lon":"-108.985202","display_name":"Test, Hidalgo County, New Mexico, United States of America","class":"highway","type":"residential"},{"place_id":"146209601","licence":"Data \u00a9 OpenStreetMap contributors, ODbL 1.0. http:\/\/www.openstreetmap.org\/copyright","osm_type":"way","osm_id":"169950409","boundingbox":["51.9216766357422","51.9226264953613","6.35835266113281","6.36030578613281"],"lat":"51.922229","lon":"6.3595574","display_name":"test, Terborg, Oude IJsselstreek, Gelderland, Netherlands, 7064GC, The Netherlands","class":"highway","type":"unclassified"},{"place_id":"121641029","licence":"Data \u00a9 OpenStreetMap contributors, ODbL 1.0. http:\/\/www.openstreetmap.org\/copyright","osm_type":"way","osm_id":"138101646","boundingbox":["48.4168472290039","48.4187240600586","106.92643737793","106.935089111328"],"lat":"48.4187207","lon":"106.9264403","display_name":"test, Ulaanbaatar, Mongolia","class":"highway","type":"track"},{"place_id":"91225977","licence":"Data \u00a9 OpenStreetMap contributors, ODbL 1.0. http:\/\/www.openstreetmap.org\/copyright","osm_type":"way","osm_id":"100263224","boundingbox":["42.2374801635742","42.2573432922363","43.4745407104492","43.4963645935059"],"lat":"42.2455661","lon":"43.4876285","display_name":"test, Korbouli, \u10e1\u10d0\u10e9\u10ee\u10d4\u10e0\u10d4, \u10d8\u10db\u10d4\u10e0\u10d4\u10d7\u10d8, Georgia","class":"highway","type":"track"},{"place_id":"45937102","licence":"Data \u00a9 OpenStreetMap contributors, ODbL 1.0. http:\/\/www.openstreetmap.org\/copyright","osm_type":"way","osm_id":"37684354","boundingbox":["47.6664733886719","47.6695175170898","8.04853248596191","8.05685424804688"],"lat":"47.6692689","lon":"8.0531128","display_name":"TEST, G\u00f6rwihl, Landkreis Waldshut, Baden-W\u00fcrttemberg, 48758, Germany","class":"highway","type":"track"},{"place_id":"146722724","licence":"Data \u00a9 OpenStreetMap contributors, ODbL 1.0. http:\/\/www.openstreetmap.org\/copyright","osm_type":"way","osm_id":"170697384","boundingbox":["-30.9982242584229","-30.9959011077881","150.236083984375","150.237594604492"],"lat":"-30.9982231","lon":"150.2360926","display_name":"test, Gunnedah, New South Wales, Australia","class":"highway","type":"residential"},{"place_id":"115133020","licence":"Data \u00a9 OpenStreetMap contributors, ODbL 1.0. http:\/\/www.openstreetmap.org\/copyright","osm_type":"way","osm_id":"130919210","boundingbox":["38.4372406005859","38.4438133239746","22.8776359558105","22.878833770752"],"lat":"38.4410058","lon":"22.8778737","display_name":"\u03a6\u0399\u039b\u03a9\u039d\u039f\u03a3, \u039a. \u039b\u03b5\u03b2\u03b1\u03b4\u03ad\u03c9\u03bd, \u0394\u03ae\u03bc\u03bf\u03c2 \u039b\u03b5\u03b2\u03b1\u03b4\u03ad\u03c9\u03bd, Boeotia Prefecture, Periphery of Continental Greece, Greece","class":"highway","type":"secondary"},{"place_id":"2484386814","licence":"Data \u00a9 OpenStreetMap contributors, ODbL 1.0. http:\/\/www.openstreetmap.org\/copyright","osm_type":"node","osm_id":"1890111971","boundingbox":[52.020048370361,52.040052185059,9.2299854660034,9.2499864196777],"lat":"52.0300501","lon":"9.2399864","display_name":"RH Hydrant 020, Kirchweg, Aerzen, Landkreis Hameln-Pyrmont, Lower Saxony, 31855, Germany","class":"emergency","type":"fire_hydrant"},{"place_id":"2484386812","licence":"Data \u00a9 OpenStreetMap contributors, ODbL 1.0. http:\/\/www.openstreetmap.org\/copyright","osm_type":"node","osm_id":"1890111967","boundingbox":[52.021387329102,52.041391143799,9.2297918701172,9.2497928237915],"lat":"52.0313907","lon":"9.2397924","display_name":"RH Hydrant 018, Hauptstra\u00dfe, Aerzen, Landkreis Hameln-Pyrmont, Lower Saxony, 31855, Germany","class":"emergency","type":"fire_hydrant"}]
 */

/*                                        select: function( event, ui ) {
                                                            log( ui.item ?
                                                                                "Selected: " + ui.item.value + " aka " + ui.item.id :
                                                                                                    "Nothing selected, input was " + this.value );

            $.getJSON("nominatim?q=" + 

                                                                        }
                                                                                */
                                                                                }).data( "autocomplete" )._renderItem = function( ul, item ) {
            return $( "<li></li>" )
                .data( "item.autocomplete", item )
                .append( "<a>" + item.name + " <span class=\"city\">" + item.city + "</span><span class=\"type\">(" + item.type + ")</span><span class=\"debug\"> d=" + item.distance + " s=" + item.score + "</span></a>" )
                .appendTo( ul );
}

});
</script>

</body>

</html>
