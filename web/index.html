<html>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
 <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.23/jquery-ui.min.js"></script>

<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.4/leaflet.css" />
<script src="http://cdn.leafletjs.com/leaflet-0.4/leaflet.js"></script>
<link rel="stylesheet" href="style.css" />
<style>
body {
    font-family: arial;
    font-size: 13px;
    padding: 0px;
    margin: 0px;
    max-height:100%;
}

td {
    margin: 0px;
    padding: 0px;

}

#maintable {
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
}

#topbar {
 background-color:#f0f0f0;
}

#leftcolumn {
    border-top: 1px solid rgba(100, 100, 100, 0.3);
}

#search_results_wrapper {
    height:90%;
    max-height:90%;
    overflow: auto;
}

a {
    font-weight: bold;
    text-decoration: none;
    color: #25C;
    font-size: 1.2em;
}

.string { color: green; }
.number { color: darkorange; }
.boolean { color: blue; }
.null { color: magenta; }
.key { color: red; }

.debug {
    font-size: 11px;
}

ul {
    padding-left: 0em;
}

.ui-autocomplete .ui-menu-item {
    font-size:13px;
}

.ui-autocomplete .ui-menu-item .city {
    font-size: 11px;
    color:#482;
}
.ui-autocomplete .ui-menu-item .type {
    font-size: 11px;
    color:#822;
}
.ui-autocomplete .ui-menu-item .debugÂ {
    font-size: 11px;
    color:#bbb;
}

.ui-menu {
 z-index: 1001;
}

.selected {
    background-color:#cef;
}

#map { width: 100%; height: 100% ;

  border: 1px solid rgba(100, 100, 100, 0.3);
}

.search_result span.city {
    font-size: 0.9em;
}

.search_result {
    padding-bottom: 0.3em;
}

</style>
</head>

<body>
<table id="maintable" cellpadding="0" cellspacing="0">
<tr style="height: 70px">
<td id="topbar" colspan="2" style="width:100%; vertical-align:center;">

<div class="ui-widget" style="margin:0 auto; width:100%; text-align: center">
<!--    <label for="name">Look up an OSM name</label>-->
        <input id="name" style="width:600px" />
        <label for="display_debug">debug</label>
        <input id="display_debug" type="checkbox" />
</div>
<div id="results">
</div>
</td>
</tr>
<tr>
<td style="vertical-align:top; width: 20%" id="leftcolumn">

<div id="search_results_wrapper">
<div id="search_results">

</div>
</div>

<!--<h4>Nominatim results</h4>

<div id="nominatim">
<em>Start searching ...</em>
</div>
-->

<!--
<div style="vertical-align:bottom">
  <div id="debug">
  </div>
</div>

</td>
-->
<td style="width:80%; vertical-align: top;">
<div id="map">
</div>
</td>

</tr>
</table>

<script>
/* Stolen from stackoverflow.com/questions/4810841 */
function syntaxHighlight(json) {
    if (typeof json != 'string') {
         json = JSON.stringify(json, undefined, '\t');
    }
    json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
        var cls = 'number';
        if (/^"/.test(match)) {
            if (/:$/.test(match)) {
                cls = 'key';
            } else {
                cls = 'string';
            }
        } else if (/true|false/.test(match)) {
            cls = 'boolean';
        } else if (/null/.test(match)) {
            cls = 'null';
        }
        return '<span class="' + cls + '">' + match + '</span>';
    });
}

var currentlyDisplayedData = null;
var currentlySelectedItem = null;
var map = null;
var markers = new L.LayerGroup();

function selectDisplayedItem(index) {
    item = currentlyDisplayedData[index];
    setMarkerFromItem(item);

    if (currentlySelectedItem != null) {
        currentlySelectedItem.removeClass("selected");
    }

    currentlySelectedItem = $("#displayed_item_" + index);
    currentlySelectedItem.addClass("selected");
}

function setMarkerFromItem(item) {
    markers.clearLayers();
    var latlng = new L.LatLng(item.lat, item.lon);
    markers.addLayer(new L.Marker(latlng));
    var sw = new L.LatLng(latlng.lat - 0.006, latlng.lng - 0.006);    
    var ne = new L.LatLng(latlng.lat + 0.006, latlng.lng + 0.006);    
    map.fitBounds(new L.LatLngBounds(sw, ne));
}

function displayNoResults() {
    $("#search_results").html("No results");
}

function displaySearchResults(data) {
    currentlyDisplayedData = data;
    var html = "<ul>";
    for (var i in data) {
        item = data[i];

        if (item.type == "residential") {
            image = "road";
        } else if (item.type == "place") {
            image = "bigcity";
        } else if (item.type == "highway") {
            image = "road";
        } else if (item.type == "waterway") {
            image = "river";
        } else if (item.type == "building") {
            image = "apartment";
        } else {
            image = item.type;
        }


        html+= "<li id=\"displayed_item_" + i + "\" class=\"search_result\">";
        html +="<div style=\"float:left\"><img src=\"icons/" + image + ".png\" width=\"32\"/></div>";
        html += "<div style=\"padding-left: 0.3em\"><a href=\"#\" onclick=\"selectDisplayedItem(" + i + ")\">" + item.name + "</a>";
        if (item.cities == "") {
            item.cities = "Unknown";
        }
        html+= "<br /><span class=\"city\"> " + item.cities + "</span></div>";
        html += "</li>";

/*ppend( "<a>" + item.name + " <span class=\"city\">" + item.cities +
                    " </span><span class=\"type\">(" + item.type + ")</span> <span class=\"debug\"> d=" + item.distance + " s=" + item.score + "</span></a>" )
 
                    html += "<li>" + data[i]["display_name"] + "</li>";
                }
                */
    }
    html += "</ul>";
    $("#search_results").html(html);
}

function setMarkersForAllSearchResults(data) {

}

$(document).ready(function() {
    map = L.map("map",  {
            center : new L.LatLng(25, 0),
            zoom: 3
    });
    var mapnikLayer = new L.TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                   maxZoom: 18,
                   attribution: 'OpenStreetMap'                                                                                                     
    });

    var currentData = null;


    map.addLayer(mapnikLayer);
    markers.addTo(map); 

    $( "#name" ).autocomplete({
        appendTo : '#results',
        delay : 100,
        source: function(request, response) {
            $.getJSON("complete?q=" + request.term, function(data) {
                markers.clearLayers();
                out = Array();
                for (var match in data.matches) {
                    complexMatch = data.matches[match];
                    out.push(complexMatch);
                }
                response(out);
                currentData = out;
                if ($("#display_debug").attr('checked')) {
                    $("#debug").html("<pre>" + syntaxHighlight(data.debug)+ "</pre>");
                }
            });
        },
        minLength: 2,
        open: function(){
            $(this).autocomplete('widget').css('z-index', 1001);
            return false;
        },
    
        select: function( event, ui ) {
            $( "#name" ).val( ui.item.name );
            idx = 0;
            for (var i in currentData) {
                console.info(currentData[i] + " vs" + ui.item);
                if (currentData[i].name == ui.item.name && currentData[i].lat == ui.item.lat) {
                    idx = i;
                }
            }
            /* Display all results in the left column */
            displaySearchResults(currentData);
            selectDisplayedItem(idx);

            /* 
            $("#nominatim").html("Searching ...");
    
            $.getJSON("nominatim?q=" + ui.item.name + "&format=json&contact=clement.stenac@gmail.com", function(data) {
                var html = "<ul>";
                for (var i in data) {
                    html += "<li>" + data[i]["display_name"] + "</li>";
                }
                html += "</ul>";
                $("#nominatim").html(html);
            });
            */
            return false;
        }
                                                                            
    }).data("autocomplete")._renderItem = function( ul, item ) {
        return $( "<li></li>" )
            .data( "item.autocomplete", item )
            .append( "<a>" + item.name + " <span class=\"city\">" + item.cities +
                    " </span><span class=\"type\">(" + item.type + ")</span> <span class=\"debug\"> d=" + item.distance + " s=" + item.score + "</span></a>" )
            .appendTo( ul );
    }

    $("#name").keypress(function (e) {
        if (e.which == 13) {
            $("#name").autocomplete("close");
            $.getJSON("complete?q=" + $("#name").val(), function(data) {
                markers.clearLayers();
                out = Array();
                for (var match in data.matches) {
                    complexMatch = data.matches[match];
                    out.push(complexMatch);
                }
                currentData = out;
                if (currentData.length > 0) {
                    displaySearchResults(currentData);
                    selectDisplayedItem(0);
                } else {
                    displayNoResults();
                }
                if ($("#display_debug").attr('checked')) {
                    $("#debug").html("<pre>" + syntaxHighlight(data.debug)+ "</pre>");
                }
            });
        }
    });
});

</script>

</body>

</html>
